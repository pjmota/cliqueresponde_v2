name: Deploy Backend - Teste SSH

on:
  push:
    branches:
      - test_ssh

jobs:
  checkout:
    name: Checkout do Repositório
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v3

  deploy:
    name: SSH e Atualização do Repositório
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: Acessar servidor e atualizar código
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # Variáveis
            REPO_URL="https://github.com/Clique-Responde/cliqueresponde_v2.git"
            DEST_DIR="/home/cliqueresponde_v2"
            BRANCH="prod"

            # Clonar se não existir, senão pull
            if [ ! -d "$DEST_DIR" ]; then
              git clone "$REPO_URL" "$DEST_DIR"
            else
              cd "$DEST_DIR"
              git pull origin "$BRANCH"
            fi

            # Cria o arquivo de sinalização
            echo "executa_pipeline_backend" > /home/executa_pipeline_backend.txt
